<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Winner Bot – Live</title>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 16px; background: #0b1115; color: #cbd5e1; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
      .row { display:flex; gap: 16px; }
      .col { flex:1; background:#111827; border-radius:8px; padding:12px; }
      input, select { background:#0f172a; color:#cbd5e1; border:1px solid #1f2937; border-radius:6px; padding:8px; }
      button { background:#2563eb; color:#fff; border:none; border-radius:6px; padding:8px 12px; cursor:pointer; }
      canvas { width: 100%; height: 360px; background:#0b1115; }
      table { width:100%; border-collapse: collapse; }
      th, td { padding: 6px 8px; border-bottom: 1px solid #1f2937; }
      .buy { color:#22c55e; }
      .sell { color:#ef4444; }
    </style>
  </head>
  <body>
    <header>
      <h2>Winner Bot – Live</h2>
      <div>
        <select id="pair">
          <option>EURUSD</option>
          <option>GBPUSD</option>
          <option>USDJPY</option>
          <option>AUDUSD</option>
          <option>USDCAD</option>
          <option>BTCUSD</option>
          <option>ETHUSD</option>
          <option>XAUUSD</option>
        </select>
        <select id="tf">
          <option>1m</option>
          <option>5m</option>
          <option>15m</option>
        </select>
        <button id="connect">Connect</button>
      </div>
    </header>
    <div class="row">
      <div class="col">
        <canvas id="chart"></canvas>
      </div>
      <div class="col">
        <h3>Signals</h3>
        <table id="sigTable"><thead><tr><th>Pair</th><th>Dir</th><th>Score</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <script>
      const chart = document.getElementById('chart');
      const ctx = chart.getContext('2d');
      function drawCandles(c){
        ctx.clearRect(0,0,chart.width, chart.height);
        const n = c.close.length;
        const w = chart.width, h = chart.height;
        const min = Math.min(...c.low), max = Math.max(...c.high);
        const xw = Math.max(2, Math.floor(w / Math.max(1, n)));
        for(let i=0;i<n;i++){
          const open = c.open[i], close = c.close[i], high = c.high[i], low = c.low[i];
          const x = i * xw;
          const yHigh = h - (high - min) / (max - min + 1e-9) * h;
          const yLow = h - (low - min) / (max - min + 1e-9) * h;
          const yOpen = h - (open - min) / (max - min + 1e-9) * h;
          const yClose = h - (close - min) / (max - min + 1e-9) * h;
          ctx.strokeStyle = close >= open ? '#22c55e' : '#ef4444';
          ctx.beginPath();
          ctx.moveTo(x + xw/2, yHigh); ctx.lineTo(x + xw/2, yLow); ctx.stroke();
          ctx.fillStyle = close >= open ? '#16a34a' : '#b91c1c';
          const top = Math.min(yOpen, yClose), bot = Math.max(yOpen, yClose);
          ctx.fillRect(x+1, top, Math.max(1,xw-2), Math.max(1, bot-top));
        }
      }

      async function fetchCandles(pair, tf){
        const res = await fetch(`/candles?pair=${encodeURIComponent(pair)}&timeframe=${tf}&limit=120`);
        return await res.json();
      }

      function connectSockets(pair, tf){
        const wsC = new WebSocket(`ws://${location.host}/ws/candles?pair=${encodeURIComponent(pair)}&timeframe=${tf}`);
        wsC.onopen = ()=> wsC.send('ping');
        wsC.onmessage = async (e)=>{
          const msg = JSON.parse(e.data);
          if(msg.type==='candles'){
            drawCandles(msg.data);
          }
          setTimeout(()=> wsC.send('ping'), 1000);
        }
        const wsS = new WebSocket(`ws://${location.host}/ws/signals?timeframe=${tf}`);
        wsS.onopen = ()=> wsS.send('ping');
        wsS.onmessage = (e)=>{
          const msg = JSON.parse(e.data);
          if(msg.type==='signals'){
            const tbody = document.querySelector('#sigTable tbody');
            tbody.innerHTML = '';
            Object.entries(msg.data).forEach(([p, v])=>{
              const tr = document.createElement('tr');
              tr.innerHTML = `<td>${p}</td><td class="${v.direction==='BUY'?'buy':'sell'}">${v.direction}</td><td>${v.score}</td>`;
              tbody.appendChild(tr);
            });
          }
          setTimeout(()=> wsS.send('ping'), 1000);
        }
      }

      document.getElementById('connect').onclick = async ()=>{
        const pair = document.getElementById('pair').value;
        const tf = document.getElementById('tf').value;
        const c = await fetchCandles(pair, tf);
        drawCandles(c);
        connectSockets(pair, tf);
      }
    </script>
  </body>
  </html>

